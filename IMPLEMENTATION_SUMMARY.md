# Lead Research Pipeline Implementation

## Overview
Implemented a comprehensive lead research pipeline that orchestrates enrichment and research workflows with full idempotency support.

## What Was Changed

### 1. Database Schema Updates (`/app/prisma/schema.prisma`)
Added two new fields to the `Lead` model:
- `lastStep` (String, nullable): Tracks workflow state for idempotency
  - Possible values: `enrichment_started`, `enrichment_completed`, `enrichment_failed`, `research_started`, `research_completed`, `research_failed`
- `researchResult` (Text, nullable): Stores the markdown research report generated by the research pipeline

**⚠️ IMPORTANT: You need to run Prisma migration:**
```bash
npx prisma migrate dev --name add_lead_research_fields
```

### 2. New Files Created

#### `/app/trigger/orchestrateLead.ts`
Orchestrator task that coordinates the full workflow:
- Checks `lastStep` to determine where to start/resume (idempotency)
- Runs enrichment → research pipeline sequentially
- Uses `triggerAndWait` to ensure sequential execution
- Handles all failure scenarios with smart retry logic
- Maximum duration: 15 minutes

**Key Features:**
- If `lastStep` is null: runs enrichment + research
- If `lastStep` is `enrichment_completed`: runs research only
- If `lastStep` is `enrichment_failed`: retries enrichment + research
- If `lastStep` is `research_failed`: retries research only
- If `lastStep` is `research_completed`: exits (already done)

#### `/app/trigger/researchLead.ts`
Comprehensive research pipeline with 4 phases:

**Phase 1: Extract Structured Data**
- Uses Anthropic Claude Sonnet 4.5 for quality extraction
- Extracts: name, title, LinkedIn URL, company, company LinkedIn, company URL, location, education
- Parses unstructured enrichmentData into structured format

**Phase 2: Research Current Company**
- Uses Perplexity Sonar Pro for web research
- Gathers: products/services, customers, location, size, recent news, social media posts (LinkedIn, Twitter, YouTube), blog posts

**Phase 3: Analyze Lead Relevance**
- Fetches client's features/services, testimonials, and marketing materials
- Uses Anthropic Claude Sonnet 4.5 to analyze lead's challenges vs client's value proposition
- Generates comprehensive markdown report

**Phase 4: Save Results**
- Stores research report in `researchResult` field
- Updates `lastStep` to `research_completed`

**Report Format:**
```markdown
# Lead Research: [Name]

## Lead Profile
- Name, Title, Company, LinkedIn, etc.

## Company Analysis
[Detailed company analysis]

## Why They'd Be Interested
[Specific relevance analysis]

## Recommended Talking Points
[3-5 actionable talking points]

## Recommended Assets to Share
[Relevant marketing materials]

## Recommended Testimonials to Share
[Relevant testimonials]
```

### 3. Modified Files

#### `/app/trigger/enrichLead.ts`
- Added `lastStep` tracking at start: sets to `enrichment_started`
- On success: sets to `enrichment_completed`
- On failure: sets to `enrichment_failed`
- Maintains backward compatibility with `enrichmentStatus`

#### `/app/trpc/routers/lead.ts`
- Changed `createBulk` mutation to trigger `orchestrateLeadTask` instead of `enrichLeadTask`
- Updated `list` query to include `lastStep` and `researchResult` fields

#### `/app/app/leads/page.tsx`
- Updated status display to use `lastStep` instead of `enrichmentStatus`
- Added new status badges:
  - PENDING (no lastStep)
  - ENRICHING (enrichment_started)
  - ENRICHED (enrichment_completed)
  - ENRICH FAILED (enrichment_failed)
  - RESEARCHING (research_started)
  - COMPLETED (research_completed)
  - RESEARCH FAILED (research_failed)
- Updated auto-refresh logic to refresh when `enrichment_started` or `research_started`

## How It Works

### Lead Upload Flow
1. User uploads LinkedIn URLs
2. System creates leads with `lastStep: null`
3. System triggers `orchestrate-lead` task for each lead
4. Orchestrator checks `lastStep` and runs appropriate workflow
5. UI auto-refreshes every 5 seconds while leads are processing
6. Final status shows in leads table

### Idempotency & Recovery
- If a task fails, you can re-trigger the orchestrator
- Orchestrator checks `lastStep` to determine where to resume
- No duplicate work is performed
- Failed steps can be retried individually

## Testing

After running migration, test the workflow:

1. Create a client with features, testimonials, and marketing materials
2. Upload a LinkedIn URL on the `/leads` page
3. Watch the status progress: PENDING → ENRICHING → ENRICHED → RESEARCHING → COMPLETED
4. Check the database to see `researchResult` field populated with markdown

## API Keys Required

Ensure these environment variables are set:
- `ANTHROPIC_API_KEY` (for Claude Sonnet 4.5)
- `PERPLEXITY_API_KEY` (for Sonar Pro)
- ProAPIs credentials (for enrichment)

## Next Steps

1. Run Prisma migration (see command above)
2. Test with a few leads
3. View research results in the database
4. Consider adding a UI to display the research report markdown
5. Consider adding email notifications when research completes
